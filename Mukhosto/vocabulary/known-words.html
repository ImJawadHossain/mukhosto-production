<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Known Words</title>

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
</head>
<body>
  <h1>
    <a href="/vocabulary" style="color: inherit; text-decoration: none;">
      Known Words
    </a>
  </h1>

  <!-- Top toolbar -->
  <div class="button-container" style="margin-top:10px; gap:8px; flex-wrap:wrap; justify-content:center;">
    <label class="flex items-center space-x-2 text-sm" style="margin-right:8px;">
      <input type="checkbox" id="reverse-toggle" class="accent-blue-600">
      <span>Reverse Practice</span>
    </label>

    <label class="flex items-center space-x-2 text-sm" style="margin-right:8px;">
      <input type="checkbox" id="toggle-extra" onchange="toggleExtras()">
      <span>Show Extra Data</span>
    </label>

    <button onclick="shuffleFlashcards()" class="nav-buttons">üîÄ Shuffle</button>
  </div>

  <!-- Card -->
  <div id="flashcard-container" class="flashcard-container" style="margin-top:12px;"></div>

  <!-- Bottom nav -->
  <div class="button-container">
    <button class="nav-buttons" id="previous-button" onclick="showPrevious()">Previous</button>
    <button class="nav-buttons" id="next-button" onclick="showNext()">Next</button>
  </div>

  <div class="counter" id="card-counter">1/0</div>

  <!-- Core SRS (for cleanup + reverse defaults) -->
  <script src="./srs.js"></script>

  <script>
    // ------- State -------
    let flashcards = [];
    let currentCardIndex = 0;
    let showExtraData = false;

    function normalize(s){ return String(s||"").trim().toLowerCase(); }
    function isReverseMode(){ return localStorage.getItem("reversePractice") === "1"; }

    // ------- Apply defaults (reverse & extra) -------
    document.addEventListener("DOMContentLoaded", () => {
      const revToggle = document.getElementById("reverse-toggle");
      if (revToggle) {
        revToggle.checked = isReverseMode();
        revToggle.addEventListener("change", () => {
          localStorage.setItem("reversePractice", revToggle.checked ? "1" : "0");
          const params = new URLSearchParams(window.location.search);
          params.set("reverse", revToggle.checked ? "1" : "0");
          window.location.search = params.toString();
        });
      }
      const showExtraDefault = localStorage.getItem("showExtraDefault") === "1";
      showExtraData = showExtraDefault;
      const extraChk = document.getElementById("toggle-extra");
      if (extraChk) extraChk.checked = showExtraDefault;
    });

    // ------- Keyboard shortcuts -------
    document.addEventListener('keydown', (e) => {
      if (e.key === "ArrowRight") {
        showNext();
      } else if (e.key === "ArrowLeft") {
        showPrevious();
      } else if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        const card = document.querySelector(".flashcard");
        if (card) flipCard(card);
      }
    });

    // ------- Load known words + data.xlsx -------
    window.addEventListener("DOMContentLoaded", () => {
      // read known words
      const known = JSON.parse(localStorage.getItem("knownWords") || "[]");
      if (!Array.isArray(known) || known.length === 0) {
        document.getElementById("flashcard-container").innerHTML = "<p>No known words yet.</p>";
        document.getElementById("card-counter").textContent = "0/0";
        return;
      }

      fetch("data.xlsx")
        .then(res => res.arrayBuffer())
        .then(buffer => {
          const workbook = XLSX.read(buffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          const byFront = {};
          for (const row of rows) {
            const k = normalize(row["FrontData"]);
            if (k) byFront[k] = row;
          }

          const reverse = isReverseMode();
          flashcards = known.map(word => {
            const row = byFront[normalize(word)];
            if (row) {
              return {
                word: row["FrontData"],
                front: reverse ? (row["BackData"] || "") : (row["FrontData"] || ""),
                back:  reverse ? (row["FrontData"] || "") : (row["BackData"] || ""),
                subBack: row["SubBack"] || "",
                extras: Object.keys(row).filter(k => k.startsWith("ExtraData")).map(k => row[k])
              };
            } else {
              return {
                word: String(word),
                front: reverse ? "" : String(word),
                back:  reverse ? String(word) : "",
                subBack: "",
                extras: []
              };
            }
          });

          createFlashcard();
        })
        .catch(err => {
          document.getElementById("flashcard-container").innerHTML =
           `<p>Error loading file: ${err.message}</p>`;
        });
    });

    // ------- UI -------
    function createFlashcard() {
      const container = document.getElementById("flashcard-container");
      container.innerHTML = "";

      if (flashcards.length === 0) {
        container.innerHTML = "<p>No known words.</p>";
        document.getElementById("card-counter").textContent = "0/0";
        return;
      }

      const card = flashcards[currentCardIndex];
      const cardDiv = document.createElement("div");
      cardDiv.classList.add("flashcard");

      cardDiv.innerHTML = `
        <div class="card-inner">
          <div class="card-front">
            <button class="remove-btn" onclick="event.stopPropagation(); removeCurrentCard()">‚úñÔ∏è</button>
            <span class="word">${card.front}</span>
            <button class="pronunciation-btn" onclick="event.stopPropagation(); pronounce('${card.front}')">üîä</button>
          </div>
          <div class="card-back">
            <div class="meaning">${card.back}</div>
            <button class="pronunciation-btn" onclick="event.stopPropagation(); pronounce('${card.back}')">üîä</button>
            ${card.subBack ? `<em class="sub-definition">${card.subBack}</em>` : ""}
            ${showExtraData && card.extras && card.extras.length > 0
              ? `<div class="extras">${card.extras.map((e, i) => `${i + 1}. ${e}`).join("<br>")}</div>`
              : ""}
          </div>
        </div>
      `;

      cardDiv.onclick = () => flipCard(cardDiv);
      container.appendChild(cardDiv);

      updateCardCounter();
      updateNextButton();
    }

    function flipCard(cardElement) {
      const inner = cardElement.querySelector(".card-inner");
      inner.classList.toggle("is-flipped");
    }

    function showNext() {
      if (currentCardIndex < flashcards.length - 1) {
        currentCardIndex++;
        createFlashcard();
      } else {
        window.location.href = "/vocabulary";
      }
    }

    function showPrevious() {
      if (currentCardIndex > 0) {
        currentCardIndex--;
        createFlashcard();
      }
    }

    function updateCardCounter() {
      document.getElementById("card-counter").textContent =
        `${currentCardIndex + 1}/${flashcards.length}`;
    }

    function updateNextButton() {
      const nextBtn = document.getElementById("next-button");
      nextBtn.textContent = (currentCardIndex === flashcards.length - 1) ? "Exit" : "Next";
    }

    function toggleExtras() {
      showExtraData = document.getElementById("toggle-extra").checked;
      createFlashcard();
    }

    function pronounce(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(utterance);
    }

    function shuffleFlashcards() {
      flashcards.sort(() => Math.random() - 0.5);
      currentCardIndex = 0;
      createFlashcard();
    }

    // ------- NEW: remove from Known + purge SRS for this word -------
    function removeCurrentCard() {
      const card = flashcards[currentCardIndex];
      if (!card) return;
      const reverse = isReverseMode();
      // The canonical word for knownWords is the original FrontData
      const wordToRemove = reverse ? (card.back || card.word) : (card.word || card.front);

      // 1) Remove from knownWords list
      let known = JSON.parse(localStorage.getItem("knownWords") || "[]");
      known = known.filter(w => w !== wordToRemove);
      localStorage.setItem("knownWords", JSON.stringify(known));

      // 2) Purge SRS entries for this word (match by key or display, normalized)
      try {
        const raw = localStorage.getItem("muk_srs_v1");
        if (raw) {
          const map = JSON.parse(raw) || {};
          const target = normalize(wordToRemove);
          for (const key of Object.keys(map)) {
            const ak = normalize(key);
            const ad = normalize(map[key]?.display);
            if (ak === target || ad === target) delete map[key];
          }
          localStorage.setItem("muk_srs_v1", JSON.stringify(map));
        }
      } catch (e) {
        console.warn("Failed clearing SRS entry:", e);
      }

      // 3) Update on-screen list
      flashcards.splice(currentCardIndex, 1);
      if (currentCardIndex >= flashcards.length) currentCardIndex = flashcards.length - 1;

      if (flashcards.length === 0) {
        document.getElementById("flashcard-container").innerHTML = "<p>No known words.</p>";
        document.getElementById("card-counter").textContent = "0/0";
      } else {
        createFlashcard();
      }
    }
  </script>

  <footer class="text-center text-sm text-gray-500 mt-12 mb-6">
    <a href="/" class="text-blue-600 hover:underline">‚Üê Back to Home</a>
    <p class="mt-1">&copy; 2025 Jawad. All rights reserved.</p>
  </footer>

  <script type="module" src="/verifyAccess.js"></script>
</body>
</html>
