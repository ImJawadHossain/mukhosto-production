<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Known Vocabulary Flashcards</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
</head>
<body>

  <button onclick="exportKnownWords()" class="nav-buttons" style="margin-bottom: 20px;">‚¨á Export Known Words</button>
  <input type="file" id="import-file" accept=".xlsx" style="display: none;" onchange="importKnownWords(event)">
  <button onclick="document.getElementById('import-file').click()" class="nav-buttons">‚¨Ü Import Known Words</button>

  <h1>
    <a href="/vocabulary" style="color: inherit; text-decoration: none;">
      Known Vocabulary Flashcards
    </a>
  </h1>

  <div class="flex justify-center mb-4">
    <label class="flex items-center space-x-2 text-sm text-gray-700">
      <input type="checkbox" id="reverse-toggle" class="accent-blue-600">
      <span>Reverse Practice</span>
    </label>
  </div>

  <label>
    <input type="checkbox" id="toggle-extra" onchange="toggleExtras()" />
    Show Extra Data
  </label>

  <br>

  <button onclick="shuffleFlashcards()" class="nav-buttons" style="margin-top: 10px;">üîÄ Shuffle Cards</button>

  <div id="flashcard-container" class="flashcard-container"></div>

  <div class="button-container">
    <button class="nav-buttons" id="previous-button" onclick="showPrevious()">Previous</button>
    <button class="nav-buttons" id="next-button" onclick="showNext()">Next</button>
  </div>

  <div class="counter" id="card-counter">1/0</div>

  <script>
    let flashcards = [];
    let currentCardIndex = 0;
    let showExtraData = false;

    function getKnownWords() {
      return JSON.parse(localStorage.getItem("knownWords") || "[]");
    }

    function isReverseMode() {
      return localStorage.getItem("reversePractice") === "1";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.getElementById("reverse-toggle");
      if (!toggle) return;

      toggle.checked = isReverseMode();

      toggle.addEventListener("change", () => {
        localStorage.setItem("reversePractice", toggle.checked ? "1" : "0");
        const params = new URLSearchParams(window.location.search);
        params.set("reverse", toggle.checked ? "1" : "0");
        window.location.search = params.toString();
      });
    });


    document.addEventListener('keydown', (e) => {
  if (e.key === "ArrowRight") {
    showNext();
  } else if (e.key === "ArrowLeft") {
    showPrevious();
  } else if (e.key === " " || e.key === "Enter") {
    e.preventDefault(); // stop page from scrolling
    const card = document.querySelector(".flashcard");
    if (card) flipCard(card);
  }
});


    window.addEventListener("DOMContentLoaded", () => {
      fetch("data.xlsx")
        .then(res => res.arrayBuffer())
        .then(buffer => {
          const workbook = XLSX.read(buffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);

          const knownWords = getKnownWords();
          const reverse = isReverseMode();

          flashcards = json.filter(row => knownWords.includes(row["FrontData"]))
            .map(row => ({
              front: reverse ? (row["BackData"] || "") : (row["FrontData"] || ""),
              back: reverse ? (row["FrontData"] || "") : (row["BackData"] || ""),
              subBack: row["SubBack"] || "",
              extras: Object.keys(row).filter(k => k.startsWith("ExtraData")).map(k => row[k])
            }));

          createFlashcard();
        })
        .catch(err => {
          document.getElementById("flashcard-container").innerHTML = `<p>Error loading file: ${err.message}</p>`;
        });
    });

    function createFlashcard() {
      const container = document.getElementById("flashcard-container");
      container.innerHTML = "";

      if (flashcards.length === 0) {
        container.innerHTML = "<p>No known words to review!</p>";
        return;
      }

      const card = flashcards[currentCardIndex];
      const cardDiv = document.createElement("div");
      cardDiv.classList.add("flashcard");

cardDiv.innerHTML = `
  <div class="card-inner">
    <div class="card-front">
      <button class="remove-btn" onclick="event.stopPropagation(); removeCurrentCard()">‚úñÔ∏è</button>
      <span class="word">${card.front}</span>
      <button class="pronunciation-btn" onclick="event.stopPropagation(); pronounce('${card.front}')">üîä</button>
    </div>
    <div class="card-back">
      <div class="meaning">${card.back}</div>
      <button class="pronunciation-btn" onclick="event.stopPropagation(); pronounce('${card.back}')">üîä</button>
      ${card.subBack ? `<em class="sub-definition">${card.subBack}</em>` : ""}
      ${showExtraData && card.extras.length > 0
        ? `<div class="extras">${card.extras.map((e, i) => `${i + 1}. ${e}`).join("<br>")}</div>`
        : ""}
    </div>
  </div>
`;




      cardDiv.onclick = () => flipCard(cardDiv);
      container.appendChild(cardDiv);

      updateCardCounter();
      updateNextButton();
    }



  function removeCurrentCard() {
    const card = flashcards[currentCardIndex];
    if (!card) return;

    let knownWords = getKnownWords();
    const wordToRemove = isReverseMode() ? card.back : card.front;
    knownWords = knownWords.filter(w => w !== wordToRemove);
    localStorage.setItem("knownWords", JSON.stringify(knownWords));

    flashcards.splice(currentCardIndex, 1);

    if (currentCardIndex >= flashcards.length) {
      currentCardIndex = flashcards.length - 1;
    }

    if (flashcards.length === 0) {
      document.getElementById("flashcard-container").innerHTML = "<p>No known words to review!</p>";
      document.getElementById("card-counter").textContent = "0/0";
    } else {
      createFlashcard();
    }
}


    function flipCard(cardElement) {
      const inner = cardElement.querySelector(".card-inner");
      inner.classList.toggle("is-flipped");
    }

    function showNext() {
      if (currentCardIndex < flashcards.length - 1) {
        currentCardIndex++;
        createFlashcard();
      } else {
        window.location.href = "/vocabulary";
      }
    }

    function showPrevious() {
      if (currentCardIndex > 0) {
        currentCardIndex--;
        createFlashcard();
      }
    }

    function updateCardCounter() {
      document.getElementById("card-counter").textContent = `${currentCardIndex + 1}/${flashcards.length}`;
    }

    function updateNextButton() {
      const nextBtn = document.getElementById("next-button");
      if (currentCardIndex === flashcards.length - 1) {
        nextBtn.textContent = "Exit";
      } else {
        nextBtn.textContent = "Next";
      }
    }

    function toggleExtras() {
      showExtraData = document.getElementById("toggle-extra").checked;
      createFlashcard();
    }

    function pronounce(word) {
      const utterance = new SpeechSynthesisUtterance(word);
      window.speechSynthesis.speak(utterance);
    }

    function shuffleFlashcards() {
      flashcards.sort(() => Math.random() - 0.5);
      currentCardIndex = 0;
      createFlashcard();
    }

function importKnownWords(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // Raw array, no headers

    const importedWords = json.flat().filter(Boolean); // Flatten and remove empty cells

    if (importedWords.length > 0) {
      localStorage.setItem("knownWords", JSON.stringify(importedWords));
      alert("Known words imported successfully!");
      location.reload();
    } else {
      alert("No valid known words found in the file.");
    }
  };
  reader.readAsArrayBuffer(file);
}


function exportKnownWords() {
  const knownWords = getKnownWords();

  if (knownWords.length === 0) {
    alert("No known words to export!");
    return;
  }

  const rows = knownWords.map(word => [word]); // Just one column without header

  const worksheet = XLSX.utils.aoa_to_sheet(rows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Known Words");

  XLSX.writeFile(workbook, "known_words.xlsx");
}

  </script>

  <br><br><br><br>

  <footer class="text-center text-sm text-gray-500 mt-12 mb-6">
    <a href="/" class="text-blue-600 hover:underline">‚Üê Back to Home</a>
    <p class="mt-1">&copy; 2025 Jawad. All rights reserved.</p>
  </footer>

  <script type="module" src="/verifyAccess.js"></script>

</body>
</html>
